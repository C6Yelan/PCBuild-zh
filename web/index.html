<!doctype html>
<meta charset="utf-8" />
<title>PCBuild-zh Â· Chat</title>
<style>
  :root { color-scheme: light dark; }
  :root {
    --surface: Canvas;
    --text: CanvasText;
    --border: color-mix(in srgb, CanvasText 12%, Canvas);
    --msg-bg: color-mix(in srgb, CanvasText 6%, Canvas);
    --code-bg: color-mix(in srgb, CanvasText 8%, Canvas);
    --thead-bg: color-mix(in srgb, CanvasText 6%, Canvas);
    --row-alt: color-mix(in srgb, CanvasText 3%, Canvas);
  }
  body {
    font-family: ui-sans-serif, system-ui, -apple-system, "Segoe UI", "Noto Sans TC", "PingFang TC", "Microsoft JhengHei";
    max-width: 980px; margin: 0 auto; padding: 20px 16px; line-height: 1.6;
    background: var(--surface); color: var(--text);
  }
  h1 { font-size: 18px; margin: 0 0 12px; }

  /* è¨Šæ¯åˆ—è¡¨ï¼ˆChatGPT é¢¨æ ¼ï¼‰ */
  #log {
    border: 1px solid var(--border); border-radius: 12px;
    height: 68vh; overflow: auto; background: var(--surface);
  }
  .chat-row {
    display: grid; grid-template-columns: 40px 1fr; gap: 12px;
    padding: 16px; border-bottom: 1px solid var(--border);
  }
  .chat-row:last-child { border-bottom: 0; }
  .avatar {
    width: 32px; height: 32px; border-radius: 50%;
    display: grid; place-items: center; font-size: 16px;
    background: color-mix(in srgb, CanvasText 10%, Canvas);
    user-select: none;
  }
  .avatar.user { background: color-mix(in srgb, CanvasText 15%, Canvas); }
  .avatar.ai   { background: color-mix(in srgb, CanvasText 10%, Canvas); }
  .message { background: var(--msg-bg); border-radius: 12px; padding: 12px 14px; }

  /* Markdown/è¡¨æ ¼/ç¨‹å¼ç¢¼ */
  .markdown-body { white-space: normal; overflow-wrap: anywhere; }
  .markdown-body p { margin: 0.6em 0; }
  .markdown-body code {
    font-family: ui-monospace, Menlo, Consolas, "Liberation Mono", monospace;
    padding: .15em .35em; border-radius: 4px; background: color-mix(in srgb, CanvasText 10%, Canvas);
  }
  .markdown-body pre { padding: 12px; border-radius: 8px; overflow: auto; background: var(--code-bg); }
  .markdown-body pre code { background: transparent; padding: 0; }
  .markdown-body table { border-collapse: collapse; width: 100%; margin: 10px 0; font-size: 0.95rem; }
  .markdown-body th, .markdown-body td { border: 1px solid var(--border); padding: 6px 8px; vertical-align: top; }
  .markdown-body thead th { background: var(--thead-bg); }
  .markdown-body tbody tr:nth-child(odd) { background: var(--row-alt); }

  /* Composerï¼šæŒ‰éˆ•åœ¨è¼¸å…¥æ¡†å¤–ã€å³å´ï¼›è¼¸å…¥æ¡†è‡ªå‹•å¢é«˜ï¼ˆä¸Šé™ 40vhï¼‰ */
  .composer-wrap { margin-top: 12px; position: sticky; bottom: 0; background: var(--surface); }
  .composer {
    display: grid; grid-template-columns: 1fr auto; gap: 10px; align-items: end;
    border: 1px solid var(--border); border-radius: 12px; padding: 10px;
  }
  #chat-input {
    width: 100%;
    min-height: 52px;
    height: auto;                   /* JS å‹•æ…‹é«˜åº¦ */
    max-height: 40vh;               /* ä¸Šé™ 40vh */
    overflow-y: hidden;             /* è¶…éä¸Šé™æ”¹ JS è¨­ç‚º auto */
    resize: none;                   /* ç¦æ­¢äººå·¥æ‹–æ‹‰ */
    font-size: 16px; line-height: 1.5;
    padding: 12px;
    border: 1px solid var(--border); border-radius: 8px;
    box-sizing: border-box;
  }
  #chat-send-btn {
    align-self: end;                /* åº•å°é½Š */
    font-size: 14px; padding: 10px 14px; height: 40px;
    border-radius: 10px; border: 1px solid var(--border);
    background: color-mix(in srgb, CanvasText 5%, Canvas);
    cursor: pointer;
  }
  .form-hint {
    margin-top: 8px;
    font-size: 13px;
    color: color-mix(in srgb, CanvasText 60%, Canvas);
  }

  /* æ–°å¢ï¼šé ‚éƒ¨è¨»å†Š / ç™»å…¥åˆ— */
  .top-bar {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 12px;
  }
  .top-bar__logo {
    font-weight: bold;
    font-size: 18px;
  }
  .top-bar__actions {
    display: flex;
    gap: 8px;
  }
  .top-bar__button {
    padding: 6px 12px;
    border-radius: 6px;
    border: 1px solid var(--border);
    text-decoration: none;
    font-size: 14px;
    color: var(--text);
    background: color-mix(in srgb, CanvasText 5%, Canvas);
  }
  .top-bar__button:hover {
    background: color-mix(in srgb, CanvasText 10%, Canvas);
  }
  .top-bar__user {
  display: flex;
  flex-direction: column;
  gap: 2px;
  }
  .top-bar__verify-link {
    font-size: 13px;
    color: #d00;
    text-decoration: underline;
  }
  .top-bar__verify-link:hover {
    text-decoration: none;
  }
</style>

<!-- æ–°å¢ï¼šå³ä¸Šè§’è¨»å†Š / ç™»å…¥æŒ‰éˆ• -->
<header class="top-bar">
  <div class="top-bar__logo">PCBuild-zh</div>
  <div class="top-bar__actions" id="top-bar-actions">
    <a href="/register.html" class="top-bar__button">è¨»å†Š</a>
    <a href="/login.html" class="top-bar__button">ç™»å…¥</a>
  </div>
</header>

<h1>å’Œ AI å°è©±</h1>
<div id="log"></div>

<div class="composer-wrap">
  <div class="composer">
    <textarea id="chat-input" placeholder="è¼¸å…¥è¨Šæ¯â€¦" aria-label="è¨Šæ¯è¼¸å…¥"></textarea>
    <button id="chat-send-btn" aria-label="é€å‡ºè¨Šæ¯">é€å‡º</button>
  </div>
</div>
<div id="chat-hint" class="form-hint"></div>

<!-- Markdown è§£æï¼‹XSS å®‰å…¨æ¶ˆæ¯’ï¼ˆCDNï¼‰ -->
<script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/dompurify@3.1.6/dist/purify.min.js"></script>

<script>
const API = "/api/chat";
const log = document.getElementById('log');
const chatInput = document.getElementById('chat-input');
const chatSendBtn = document.getElementById('chat-send-btn');
const chatHint = document.getElementById('chat-hint');
const topBarActions = document.getElementById('top-bar-actions');

marked.setOptions({ gfm: true, breaks: true, headerIds: false, mangle: false });

// === æ–°å¢ï¼šé›†ä¸­æ¸…ç† Email é©—è­‰æµç¨‹ç”¨çš„ sessionStorage ===
const VERIFY_STORAGE_KEYS = [
  "pcbuild_verify_email",
  "pcbuild_verify_email_expires_at",
  "pcbuild_verify_flow",
  "pcbuild_verify_cooldown_until",
];

function clearVerifySessionStorage() {
  try {
    for (const k of VERIFY_STORAGE_KEYS) sessionStorage.removeItem(k);
  } catch (_) {
    // ignore
  }
}

/* === æ–°å¢ï¼šåœ¨å‰ç«¯ä¿å­˜æœ€è¿‘ N ç­†å°è©±ï¼ˆç´”æ–‡å­—ï¼‰ === */
const HISTORY_LIMIT = 8;
const history = [];  // [{role:"user"|"ai", content:"..."}]

function row(who, innerHTML) {
  const wrap = document.createElement('div');
  wrap.className = 'chat-row';
  const avatar = document.createElement('div');
  avatar.className = `avatar ${who}`;
  avatar.textContent = (who === 'user') ? 'ğŸ§‘' : 'ğŸ¤–';
  const message = document.createElement('div');
  message.className = 'message markdown-body';
  message.innerHTML = innerHTML;
  wrap.appendChild(avatar);
  wrap.appendChild(message);
  return wrap;
}

function appendMarkdown(who, md, inline=false) {
  const html = inline ? marked.parseInline(md) : marked.parse(md);
  const safe = DOMPurify.sanitize(html);
  const wrap = row(who, safe);
  log.appendChild(wrap);
  log.scrollTop = log.scrollHeight;
}

/* è‡ªå‹•å¢é«˜ç¶­æŒä½ åŸæœ¬ç‰ˆæœ¬ */
function autoResize() {
  const maxPx = Math.floor(window.innerHeight * 0.40);
  const minPx = parseFloat(getComputedStyle(chatInput).minHeight) || 52;
  chatInput.style.height = 'auto';
  const h = Math.min(chatInput.scrollHeight, maxPx);
  chatInput.style.height = Math.max(h, minPx) + 'px';
  chatInput.style.overflowY = (chatInput.scrollHeight > maxPx) ? 'auto' : 'hidden';
}

async function send() {
if (!chatEnabled) {
  if (chatMode === "unverified") configureChatForUnverifiedUser();
  else configureChatForGuest();
  return;
}

  const m = chatInput.value.trim();
  if (!m) return;

  // UI å…ˆé¡¯ç¤º
  appendMarkdown('user', m, true);

  // === æº–å‚™ payloadï¼šæŠŠæœ€è¿‘ N ç­† history ä¸€èµ·é€åˆ°å¾Œç«¯ ===
  const payload = {
    message: m,
    history: history.slice(-HISTORY_LIMIT)   // æ³¨æ„ï¼šrole å¿…é ˆæ˜¯ "user" æˆ– "ai"
  };

  chatInput.value = '';
  autoResize();
  chatInput.focus();
  chatSendBtn.disabled = true;

  try {
    const r = await fetch(API, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      credentials: "same-origin",
      body: JSON.stringify(payload),
    });
    const data = await r.json();
    const aiText = String(data?.reply ?? '');

    // UI é¡¯ç¤º AI
    appendMarkdown('ai', aiText, false);

    // === æˆåŠŸå¾Œå†æŠŠã€Œæœ¬è¼ªã€åŠ å…¥ historyï¼ˆç´”æ–‡å­—ï¼Œä¸è¦å¡ HTMLï¼‰===
    history.push({ role: 'user', content: m });
    history.push({ role: 'ai', content: aiText });

    // å¯é¸ï¼šåªä¿ç•™ä¸Šé™ï¼Œé¿å…è¨˜æ†¶é«”æš´å¢
    if (history.length > HISTORY_LIMIT * 2) {
      history.splice(0, history.length - HISTORY_LIMIT * 2);
    }
  } catch (e) {
    appendMarkdown('ai', `ç™¼ç”ŸéŒ¯èª¤ï¼š\`${String(e)}\``, false);
  } finally {
    chatSendBtn.disabled = false;
  }
}

let chatEnabled = false;
let chatMode = "guest"; // "guest" | "unverified" | "active"

// æœªç™»å…¥ä½¿ç”¨è€…çš„èŠå¤©ä»‹é¢è¨­å®š
function configureChatForGuest() {
  chatMode = "guest";
  chatEnabled = false;

  if (chatInput) {
    chatInput.value = '';
    chatInput.disabled = true;
    chatInput.placeholder = "è¦ä½¿ç”¨ AI èŠå¤©èˆ‡é…å–®åŠŸèƒ½ï¼Œè«‹å…ˆç™»å…¥æˆ–è¨»å†Šå¸³è™Ÿã€‚";
  }
  if (chatSendBtn) {
    chatSendBtn.disabled = true;
  }
  if (chatHint) {
    chatHint.textContent = "æ‚¨ç›®å‰å°šæœªç™»å…¥ï¼Œç„¡æ³•ä½¿ç”¨ AI èŠå¤©åŠŸèƒ½ã€‚è«‹å…ˆç™»å…¥æˆ–è¨»å†Šå¸³è™Ÿã€‚";
  }
}

// æœªé©—è­‰ä½¿ç”¨è€…çš„èŠå¤©ä»‹é¢è¨­å®š
function configureChatForUnverifiedUser() {
  chatMode = "unverified";
  chatEnabled = false;

  if (chatInput) {
    chatInput.value = '';
    chatInput.disabled = true;
    chatInput.placeholder = "å¸³è™Ÿå°šæœªå®Œæˆ Email é©—è­‰ï¼Œæš«æ™‚ç„¡æ³•ä½¿ç”¨ AI èŠå¤©åŠŸèƒ½ã€‚";
  }
  if (chatSendBtn) {
    chatSendBtn.disabled = true;
  }
  if (chatHint) {
    chatHint.textContent = "æ‚¨çš„å¸³è™Ÿå°šæœªå®Œæˆ Email é©—è­‰ã€‚è«‹å…ˆå®Œæˆé©—è­‰å¾Œå†ä½¿ç”¨ AI èŠå¤©åŠŸèƒ½ã€‚";
  }
}

// å·²å•Ÿç”¨ä½¿ç”¨è€…çš„èŠå¤©ä»‹é¢è¨­å®š
function configureChatForActiveUser() {
  chatMode = "active";
  chatEnabled = true;

  if (chatInput) {
    chatInput.disabled = false;
    chatInput.placeholder = "è«‹è¼¸å…¥æƒ³è©¢å•çš„é…å–®éœ€æ±‚æˆ–å•é¡Œâ€¦";
  }
  if (chatSendBtn) {
    chatSendBtn.disabled = false;
  }
  if (chatHint) {
    chatHint.textContent = '';
  }
}

async function initHomeAuthGuard() {
  try {
    const resp = await fetch("/api/auth/me", {
      method: "GET",
      credentials: "same-origin",
    });

    if (!resp.ok) {
      configureChatForGuest();
      return;
    }

    const data = await resp.json();

    if (data && data.is_active === false) {
      configureChatForUnverifiedUser();
      return;
    }
    // æ–°å¢ï¼šå·²é©—è­‰ç‹€æ…‹ï¼Œæ¸…æ‰ä»»ä½•æ®˜ç•™çš„ verify sessionStorage
    clearVerifySessionStorage();
    configureChatForActiveUser();
  } catch (err) {
    console.error("initHomeAuthGuard failed:", err);
    configureChatForGuest();
  }
}

async function loadAuthState() {
  if (!topBarActions) return;

  try {
    const resp = await fetch("/api/auth/me", {
      method: "GET",
      credentials: "same-origin",
    });

    if (!resp.ok) return;

    const data = await resp.json();
    // æ–°å¢ï¼šè‹¥å¸³è™Ÿå·²é©—è­‰ï¼Œæ¸…æ‰ verify sessionStorageï¼ˆé¿å…å…¶ä»–é æ²’æ¸…åˆ°ï¼‰
    if (data && data.is_active === true) clearVerifySessionStorage();
    const username = data.username || data.email || "User";

    topBarActions.textContent = "";

    // å·²ç™»å…¥ â†’ é¡¯ç¤ºä½¿ç”¨è€…åç¨± +ï¼ˆå°šæœªé©—è­‰é€£çµï¼‰+ ç™»å‡ºæŒ‰éˆ•
    topBarActions.textContent = "";

    // æŠŠã€Œæ­¡è¿æ–‡å­—ã€èˆ‡ã€Œå°šæœªé©—è­‰ã€æ”¾åŒä¸€å€‹å€å¡Šï¼ˆä¸Šä¸‹æ’åˆ—ï¼‰
    const userBlock = document.createElement("div");
    userBlock.style.display = "flex";
    userBlock.style.flexDirection = "column";
    userBlock.style.alignItems = "flex-end";
    userBlock.style.gap = "4px";
    userBlock.style.marginRight = "12px";

    const welcome = document.createElement("span");
    welcome.style.fontSize = "14px";
    welcome.textContent = `æ­¡è¿ï¼Œ${username}`;
    userBlock.appendChild(welcome);

    // æœªé©—è­‰ï¼šé¡¯ç¤ºç´…è‰²è¶…é€£çµï¼ˆåœ¨æ­¡è¿æ–‡å­—ä¸‹æ–¹ï¼‰
    // é»æ“Šå¾Œï¼šå…ˆå˜—è©¦é‡å¯„é©—è­‰ä¿¡ + å¯«å…¥å†·å»æ™‚é–“åˆ° sessionStorage + è½‰åˆ° pending é 
    if (data && data.is_active === false) {
      const COOLDOWN_KEY = "pcbuild_verify_cooldown_until";
      const DEFAULT_WAIT_SEC = 60;

      const verifyLink = document.createElement("a");
      verifyLink.href = "/verify-email-pending.html";
      verifyLink.textContent = "å°šæœªé©—è­‰ï¼ˆé»æ­¤å‰å¾€é©—è­‰ï¼‰";
      verifyLink.title = "å‰å¾€ Email é©—è­‰èˆ‡é‡æ–°å¯„é€é©—è­‰ä¿¡";
      verifyLink.style.fontSize = "12px";
      verifyLink.style.color = "#ff4d4f";
      verifyLink.style.textDecoration = "underline";

      verifyLink.addEventListener("click", async (e) => {
        e.preventDefault();
          // æ–°å¢ï¼šæ¨™è¨˜é€™æ¬¡æ˜¯ã€Œå·²ç™»å…¥æœªé©—è­‰ â†’ å¾é¦–é é€²å…¥é©—è­‰ã€æµç¨‹
        try {
          sessionStorage.setItem("pcbuild_verify_flow", "home");
        } catch (_) {}

        // å¦‚æœåŒåˆ†é å·²æœ‰å†·å»ä¸­çš„æ™‚é–“æˆ³ï¼Œå°±ä¸è¦é‡æ‰“ APIï¼Œç›´æ¥é€² pending è®“å®ƒé¡¯ç¤ºå€’æ•¸
        let untilMs = 0;
        try {
          untilMs = parseInt(sessionStorage.getItem(COOLDOWN_KEY) || "0", 10) || 0;
        } catch (_) {
          untilMs = 0;
        }

        if (untilMs && Date.now() < untilMs) {
          window.location.href = "/verify-email-pending.html";
          return;
        }

        try {
          const r = await fetch("/api/auth/resend-verification", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            credentials: "same-origin",
            body: JSON.stringify({}), // ç”±å¾Œç«¯ç”¨ session åˆ¤å®š userï¼Œä¸æ”¾ email
          });

          // æˆåŠŸæˆ–è¢« rate limit æ™‚ï¼Œå¯«å…¥å†·å»æ™‚é–“ï¼Œè®“ pending é ä¸€è¼‰å…¥å°±èƒ½å€’æ•¸
          if (r.ok || r.status === 429) {
            let waitSec = DEFAULT_WAIT_SEC;

            if (r.status === 429) {
              // è‹¥å¾Œç«¯æœ‰å› Retry-Afterï¼Œç›¡é‡å°Šé‡å®ƒï¼ˆé€šå¸¸æ˜¯ç§’æ•¸ï¼‰
              const ra = r.headers.get("Retry-After");
              const n = ra ? parseInt(ra, 10) : NaN;
              if (!Number.isNaN(n) && n > 0) waitSec = Math.min(n, 600);
            }

            try {
              sessionStorage.setItem(COOLDOWN_KEY, String(Date.now() + waitSec * 1000));
            } catch (_) {
              // sessionStorage å¤±æ•—å°±å¿½ç•¥ï¼ˆä¸å½±éŸ¿è½‰å°ï¼‰
            }
          }
        } catch (_) {
          // ç¶²è·¯éŒ¯èª¤ä¸é˜»æ“‹è½‰å°ï¼šä¸é¡¯ç¤ºæˆåŠŸ/å¤±æ•—ï¼Œåªè®“ä½¿ç”¨è€…åˆ° pending é å†æ“ä½œ
        } finally {
          window.location.href = "/verify-email-pending.html";
        }
      });

      userBlock.appendChild(verifyLink);
    }

    topBarActions.appendChild(userBlock);

    const logoutBtn = document.createElement("button");
    logoutBtn.id = "logout-btn";
    logoutBtn.className = "top-bar__button";
    logoutBtn.type = "button";
    logoutBtn.textContent = "ç™»å‡º";
    topBarActions.appendChild(logoutBtn);

    logoutBtn.addEventListener("click", async () => {
      try {
        await fetch("/api/auth/logout", {
          method: "POST",
          credentials: "same-origin",
        });
      } catch (e) {
        // ignore
      } finally {
        clearVerifySessionStorage();
        window.location.href = "/";
      }
    });
  } catch (e) {
    console.error("loadAuthState error:", e);
  }
}


chatSendBtn.onclick = send;
/* Enter é€å‡ºï¼›Shift+Enter æ›è¡Œ */
chatInput.addEventListener('keydown', (e) => {
  if (e.key === 'Enter' && !e.shiftKey) {
    e.preventDefault();
    send();
  }
});
chatInput.addEventListener('input', autoResize);
window.addEventListener('resize', autoResize);
document.addEventListener('DOMContentLoaded', () => {
  configureChatForGuest();
  autoResize();
  initHomeAuthGuard();
  loadAuthState();
});
</script>
