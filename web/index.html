<!doctype html>
<meta charset="utf-8" />
<title>PCBuild-zh Â· Chat</title>
<style>
  :root { color-scheme: light dark; }
  :root {
    --surface: Canvas;
    --text: CanvasText;
    --border: color-mix(in srgb, CanvasText 12%, Canvas);
    --msg-bg: color-mix(in srgb, CanvasText 6%, Canvas);
    --code-bg: color-mix(in srgb, CanvasText 8%, Canvas);
    --thead-bg: color-mix(in srgb, CanvasText 6%, Canvas);
    --row-alt: color-mix(in srgb, CanvasText 3%, Canvas);
  }
  body {
    font-family: ui-sans-serif, system-ui, -apple-system, "Segoe UI", "Noto Sans TC", "PingFang TC", "Microsoft JhengHei";
    max-width: 980px; margin: 0 auto; padding: 20px 16px; line-height: 1.6;
    background: var(--surface); color: var(--text);
  }
  h1 { font-size: 18px; margin: 0 0 12px; }

  /* è¨Šæ¯åˆ—è¡¨ï¼ˆChatGPT é¢¨æ ¼ï¼‰ */
  #log {
    border: 1px solid var(--border); border-radius: 12px;
    height: 68vh; overflow: auto; background: var(--surface);
  }
  .chat-row {
    display: grid; grid-template-columns: 40px 1fr; gap: 12px;
    padding: 16px; border-bottom: 1px solid var(--border);
  }
  .chat-row:last-child { border-bottom: 0; }
  .avatar {
    width: 32px; height: 32px; border-radius: 50%;
    display: grid; place-items: center; font-size: 16px;
    background: color-mix(in srgb, CanvasText 10%, Canvas);
    user-select: none;
  }
  .avatar.user { background: color-mix(in srgb, CanvasText 15%, Canvas); }
  .avatar.ai   { background: color-mix(in srgb, CanvasText 10%, Canvas); }
  .message { background: var(--msg-bg); border-radius: 12px; padding: 12px 14px; }

  /* Markdown/è¡¨æ ¼/ç¨‹å¼ç¢¼ */
  .markdown-body { white-space: normal; overflow-wrap: anywhere; }
  .markdown-body p { margin: 0.6em 0; }
  .markdown-body code {
    font-family: ui-monospace, Menlo, Consolas, "Liberation Mono", monospace;
    padding: .15em .35em; border-radius: 4px; background: color-mix(in srgb, CanvasText 10%, Canvas);
  }
  .markdown-body pre { padding: 12px; border-radius: 8px; overflow: auto; background: var(--code-bg); }
  .markdown-body pre code { background: transparent; padding: 0; }
  .markdown-body table { border-collapse: collapse; width: 100%; margin: 10px 0; font-size: 0.95rem; }
  .markdown-body th, .markdown-body td { border: 1px solid var(--border); padding: 6px 8px; vertical-align: top; }
  .markdown-body thead th { background: var(--thead-bg); }
  .markdown-body tbody tr:nth-child(odd) { background: var(--row-alt); }

  /* Composerï¼šæŒ‰éˆ•åœ¨è¼¸å…¥æ¡†å¤–ã€å³å´ï¼›è¼¸å…¥æ¡†è‡ªå‹•å¢é«˜ï¼ˆä¸Šé™ 40vhï¼‰ */
  .composer-wrap { margin-top: 12px; position: sticky; bottom: 0; background: var(--surface); }
  .composer {
    display: grid; grid-template-columns: 1fr auto; gap: 10px; align-items: end;
    border: 1px solid var(--border); border-radius: 12px; padding: 10px;
  }
  #msg {
    width: 100%;
    min-height: 52px;
    height: auto;                   /* JS å‹•æ…‹é«˜åº¦ */
    max-height: 40vh;               /* ä¸Šé™ 40vh */
    overflow-y: hidden;             /* è¶…éä¸Šé™æ”¹ JS è¨­ç‚º auto */
    resize: none;                   /* ç¦æ­¢äººå·¥æ‹–æ‹‰ */
    font-size: 16px; line-height: 1.5;
    padding: 12px;
    border: 1px solid var(--border); border-radius: 8px;
    box-sizing: border-box;
  }
  #send {
    align-self: end;                /* åº•å°é½Š */
    font-size: 14px; padding: 10px 14px; height: 40px;
    border-radius: 10px; border: 1px solid var(--border);
    background: color-mix(in srgb, CanvasText 5%, Canvas);
    cursor: pointer;
  }
</style>

<h1>å’Œ AI å°è©±</h1>
<div id="log"></div>

<div class="composer-wrap">
  <div class="composer">
    <textarea id="msg" placeholder="è¼¸å…¥è¨Šæ¯â€¦" aria-label="è¨Šæ¯è¼¸å…¥"></textarea>
    <button id="send" aria-label="é€å‡ºè¨Šæ¯">é€å‡º</button>
  </div>
</div>

<!-- Markdown è§£æï¼‹XSS å®‰å…¨æ¶ˆæ¯’ï¼ˆCDNï¼‰ -->
<script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/dompurify@3.1.6/dist/purify.min.js"></script>

<script>
const API = "/api/chat";
const log = document.getElementById('log');
const msg = document.getElementById('msg');
const sendBtn = document.getElementById('send');

marked.setOptions({ gfm: true, breaks: true, headerIds: false, mangle: false });

/* === æ–°å¢ï¼šåœ¨å‰ç«¯ä¿å­˜æœ€è¿‘ N ç­†å°è©±ï¼ˆç´”æ–‡å­—ï¼‰ === */
const HISTORY_LIMIT = 8;
const history = [];  // [{role:"user"|"ai", content:"..."}]

function row(who, innerHTML) {
  const wrap = document.createElement('div');
  wrap.className = 'chat-row';
  const avatar = document.createElement('div');
  avatar.className = `avatar ${who}`;
  avatar.textContent = (who === 'user') ? 'ğŸ§‘' : 'ğŸ¤–';
  const message = document.createElement('div');
  message.className = 'message markdown-body';
  message.innerHTML = innerHTML;
  wrap.appendChild(avatar);
  wrap.appendChild(message);
  return wrap;
}

function appendMarkdown(who, md, inline=false) {
  const html = inline ? marked.parseInline(md) : marked.parse(md);
  const safe = DOMPurify.sanitize(html);
  const wrap = row(who, safe);
  log.appendChild(wrap);
  log.scrollTop = log.scrollHeight;
}

/* è‡ªå‹•å¢é«˜ç¶­æŒä½ åŸæœ¬ç‰ˆæœ¬ */
function autoResize() {
  const maxPx = Math.floor(window.innerHeight * 0.40);
  const minPx = parseFloat(getComputedStyle(msg).minHeight) || 52;
  msg.style.height = 'auto';
  const h = Math.min(msg.scrollHeight, maxPx);
  msg.style.height = Math.max(h, minPx) + 'px';
  msg.style.overflowY = (msg.scrollHeight > maxPx) ? 'auto' : 'hidden';
}

async function send() {
  const m = msg.value.trim();
  if (!m) return;

  // UI å…ˆé¡¯ç¤º
  appendMarkdown('user', m, true);

  // === æº–å‚™ payloadï¼šæŠŠæœ€è¿‘ N ç­† history ä¸€èµ·é€åˆ°å¾Œç«¯ ===
  const payload = {
    message: m,
    history: history.slice(-HISTORY_LIMIT)   // æ³¨æ„ï¼šrole å¿…é ˆæ˜¯ "user" æˆ– "ai"
  };

  msg.value = '';
  autoResize();
  msg.focus();
  sendBtn.disabled = true;

  try {
    const r = await fetch(API, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify(payload)
    });
    const data = await r.json();
    const aiText = String(data?.reply ?? '');

    // UI é¡¯ç¤º AI
    appendMarkdown('ai', aiText, false);

    // === æˆåŠŸå¾Œå†æŠŠã€Œæœ¬è¼ªã€åŠ å…¥ historyï¼ˆç´”æ–‡å­—ï¼Œä¸è¦å¡ HTMLï¼‰===
    history.push({ role: 'user', content: m });
    history.push({ role: 'ai', content: aiText });

    // å¯é¸ï¼šåªä¿ç•™ä¸Šé™ï¼Œé¿å…è¨˜æ†¶é«”æš´å¢
    if (history.length > HISTORY_LIMIT * 2) {
      history.splice(0, history.length - HISTORY_LIMIT * 2);
    }
  } catch (e) {
    appendMarkdown('ai', `ç™¼ç”ŸéŒ¯èª¤ï¼š\`${String(e)}\``, false);
  } finally {
    sendBtn.disabled = false;
  }
}

sendBtn.onclick = send;
/* Enter é€å‡ºï¼›Shift+Enter æ›è¡Œ */
msg.addEventListener('keydown', (e) => {
  if (e.key === 'Enter' && !e.shiftKey) {
    e.preventDefault();
    send();
  }
});
msg.addEventListener('input', autoResize);
window.addEventListener('resize', autoResize);
document.addEventListener('DOMContentLoaded', autoResize);
</script>
