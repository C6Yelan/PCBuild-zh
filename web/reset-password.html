<!doctype html>
<html lang="zh-Hant">
  <head>
    <meta charset="utf-8" />
    <title>重設密碼 · PCBuild-zh</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <!-- 避免 URL token 透過 referrer 外洩 -->
    <meta name="referrer" content="no-referrer" />
    <style>
      :root { color-scheme: light dark; }
      :root {
        --surface: Canvas;
        --text: CanvasText;
        --border: color-mix(in srgb, CanvasText 12%, Canvas);
        --btn-bg: color-mix(in srgb, CanvasText 5%, Canvas);
        --btn-bg-hover: color-mix(in srgb, CanvasText 10%, Canvas);
        --error: #d93025;
      }
      body {
        margin: 0;
        min-height: 100vh;
        display: flex;
        align-items: center;
        justify-content: center;
        font-family: ui-sans-serif, system-ui, -apple-system, "Segoe UI",
          "Noto Sans TC", "PingFang TC", "Microsoft JhengHei";
        background: radial-gradient(
          circle at top,
          color-mix(in srgb, CanvasText 5%, Canvas),
          Canvas
        );
        color: var(--text);
      }
      .container {
        width: 100%;
        max-width: 420px;
        padding: 16px;
      }
      .card {
        border-radius: 16px;
        border: 1px solid var(--border);
        background: var(--surface);
        padding: 24px 20px 20px;
        box-shadow: 0 12px 30px rgba(0, 0, 0, 0.12);
      }
      .logo {
        font-weight: 700;
        font-size: 22px;
        margin-bottom: 4px;
        text-align: center;
      }
      .subtitle {
        text-align: center;
        font-size: 14px;
        margin: 0 0 20px;
        opacity: 0.9;
        line-height: 1.6;
      }

      form {
        display: flex;
        flex-direction: column;
        gap: 12px;
      }
      label {
        font-size: 14px;
      }

      /* 欄位錯誤樣式（與 register.html 相同） */
      .field {
        display: flex;
        flex-direction: column;
        gap: 4px;
      }
      .field-label-row {
        display: flex;
        justify-content: space-between;
        align-items: baseline;
      }
      .field-label-main {
        font-size: 14px;
      }
      .field-error-text {
        font-size: 12px;
        color: var(--error);
      }
      .field.field-error input {
        border-color: var(--error);
      }
      .field.field-error .field-label-main {
        color: var(--error);
      }

      input[type="password"] {
        padding: 10px 12px;
        font-size: 14px;
        border-radius: 8px;
        border: 1px solid var(--border);
        background: var(--surface);
        color: var(--text);
        box-sizing: border-box;
      }
      input:focus {
        outline: 2px solid color-mix(in srgb, CanvasText 25%, Canvas);
        outline-offset: 1px;
      }

      .actions-row {
        display: flex;
        justify-content: flex-end;
        gap: 8px;
        margin-top: 4px;
      }
      button {
        font-family: inherit;
        cursor: pointer;
      }
      .btn-primary {
        padding: 10px 18px;
        border-radius: 999px;
        border: 1px solid var(--border);
        background: var(--btn-bg);
        color: var(--text);
        font-size: 14px;
        font-weight: 500;
        min-width: 90px;
      }
      .btn-primary:hover:enabled { background: var(--btn-bg-hover); }
      .btn-primary:disabled { opacity: 0.6; cursor: default; }

      .hint {
        margin: 8px 0 0;
        font-size: 13px;
        text-align: center;
        opacity: 0.9;
        line-height: 1.6;
      }
      .hint a { color: inherit; text-decoration: underline; }
      .error {
        margin: 8px 0 0;
        font-size: 13px;
        color: var(--error);
        min-height: 1.2em;
        text-align: center;
      }
      .back-home {
        margin-top: 12px;
        text-align: center;
        font-size: 13px;
      }
      .back-home a {
        color: inherit;
        text-decoration: underline;
      }
    </style>
  </head>
  <body>
    <div class="container">
      <div class="card">
        <div class="logo">PCBuild-zh</div>
        <p class="subtitle">
          請設定新的登入密碼。
        </p>

        <form id="reset-form" novalidate>
          <label class="field" data-field="password">
            <div class="field-label-row">
              <span class="field-label-main">新密碼</span>
              <span class="field-error-text"></span>
            </div>
            <input
              id="password"
              type="password"
              autocomplete="new-password"
              required
            />
          </label>

          <label class="field" data-field="password-confirm">
            <div class="field-label-row">
              <span class="field-label-main">再次輸入新密碼</span>
              <span class="field-error-text"></span>
            </div>
            <input
              id="password-confirm"
              type="password"
              autocomplete="new-password"
              required
            />
          </label>

          <div class="actions-row">
            <button type="submit" id="reset-btn" class="btn-primary">
              重設密碼
            </button>
          </div>

          <p class="hint">
            重設成功後將導回 <a href="/login.html">登入頁</a>。
          </p>

          <p id="error" class="error" aria-live="polite"></p>
        </form>
      </div>

      <div class="back-home">
        <a href="/">回到首頁</a>
      </div>
    </div>

    <script>
      const form = document.getElementById("reset-form");
      const passwordInput = document.getElementById("password");
      const passwordConfirmInput = document.getElementById("password-confirm");
      const resetBtn = document.getElementById("reset-btn");
      const errorEl = document.getElementById("error");

      const passwordField = document.querySelector('[data-field="password"]');
      const passwordConfirmField = document.querySelector('[data-field="password-confirm"]');

      function refreshGlobalErrorFromFields() {
        const fields = [passwordField, passwordConfirmField];
        const hasError = fields.some((f) => f && f.classList.contains("field-error"));
        if (!hasError) errorEl.textContent = "";
      }

      function clearSingleFieldError(field) {
        if (!field) return;
        field.classList.remove("field-error");
        const msgEl = field.querySelector(".field-error-text");
        if (msgEl) msgEl.textContent = "";
        refreshGlobalErrorFromFields();
      }

      function setFieldError(field, message) {
        if (!field) return;
        field.classList.add("field-error");
        const msgEl = field.querySelector(".field-error-text");
        if (msgEl) msgEl.textContent = message || "";
      }

      function getToken() {
        // 1) 先看 URL query（首次從 email 進來會帶 token）
        const params = new URLSearchParams(window.location.search);
        const tokenFromUrl = params.get("token");

        // 2) 存到 sessionStorage 後把 URL token 移除，降低暴露風險
        try {
          if (tokenFromUrl) {
            sessionStorage.setItem("pcbuild_reset_token", tokenFromUrl);
            history.replaceState(null, "", "/reset-password.html");
          }
          return sessionStorage.getItem("pcbuild_reset_token") || "";
        } catch (e) {
          return tokenFromUrl || "";
        }
      }

      const token = getToken();
      if (!token) {
        // 缺 token：直接導向無效頁
        window.location.href = "/reset-password-invalid.html";
      }

      function validatePasswordField() {
        if (!passwordField) return;
        clearSingleFieldError(passwordField);
        const value = passwordInput.value;

        if (!value) {
          setFieldError(passwordField, "請填寫新密碼。");
          return;
        }
        if (value.length < 8) {
          setFieldError(passwordField, "密碼長度至少需 8 個字元。");
        }
      }

      function validatePasswordConfirmField() {
        if (!passwordConfirmField) return;
        clearSingleFieldError(passwordConfirmField);
        const v1 = passwordInput.value;
        const v2 = passwordConfirmInput.value;

        if (!v2) {
          setFieldError(passwordConfirmField, "請再次輸入新密碼。");
          return;
        }
        if (v1 !== v2) {
          setFieldError(passwordConfirmField, "兩次密碼輸入不一致。");
        }
      }

      passwordInput.addEventListener("blur", validatePasswordField);
      passwordConfirmInput.addEventListener("blur", validatePasswordConfirmField);

      form.addEventListener("submit", async (e) => {
        e.preventDefault();
        errorEl.textContent = "";

        validatePasswordField();
        validatePasswordConfirmField();

        const hasError =
          (passwordField && passwordField.classList.contains("field-error")) ||
          (passwordConfirmField && passwordConfirmField.classList.contains("field-error"));

        if (hasError) {
          errorEl.textContent = "請修正紅色標示的欄位。";
          return;
        }

        const newPassword = passwordInput.value;

        resetBtn.disabled = true;
        const originalText = resetBtn.textContent;
        resetBtn.textContent = "處理中…";

        try {
          const resp = await fetch("/api/auth/reset-password", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            credentials: "same-origin",
            body: JSON.stringify({ token, password: newPassword }),
          });

          let data = null;
          try { data = await resp.json(); } catch { data = null; }

          if (!resp.ok) {
            // 下面三個頁面你後續會建立；先預留導向邏輯
            if (resp.status === 409) window.location.href = "/reset-password-used.html";
            else if (resp.status === 410) window.location.href = "/reset-password-expired.html";
            else if (resp.status === 400) {
              const errors = data?.detail?.errors || {};
              if (errors.password) setFieldError(passwordField, String(errors.password));
              if (errors.token) window.location.href = "/reset-password-invalid.html";
              errorEl.textContent = "重設密碼失敗，請稍後再試。";
            } else {
              errorEl.textContent = "重設密碼失敗，請稍後再試。";
            }
            return;
          }

          // 成功：清除 token，導回登入頁（不自動登入）
          try { sessionStorage.removeItem("pcbuild_reset_token"); } catch {}
          window.location.href = "/login.html";
        } catch (err) {
          console.error("reset-password invalid:", err);
          errorEl.textContent = "重設密碼失敗，請稍後再試。";
        } finally {
          resetBtn.disabled = false;
          resetBtn.textContent = originalText;
        }
      });
    </script>
  </body>
</html>
