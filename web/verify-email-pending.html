<!doctype html>
<html lang="zh-Hant">
  <head>
    <meta charset="utf-8" />
    <title>請驗證電子郵件 · PCBuild-zh</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <style>
      :root {
        color-scheme: light dark;
      }
      :root {
        --surface: Canvas;
        --text: CanvasText;
        --border: color-mix(in srgb, CanvasText 12%, Canvas);
        --btn-bg: color-mix(in srgb, CanvasText 5%, Canvas);
        --btn-bg-hover: color-mix(in srgb, CanvasText 10%, Canvas);
        --muted: color-mix(in srgb, CanvasText 45%, Canvas);
      }
      body {
        margin: 0;
        min-height: 100vh;
        display: flex;
        align-items: center;
        justify-content: center;
        font-family: ui-sans-serif, system-ui, -apple-system, "Segoe UI",
          "Noto Sans TC", "PingFang TC", "Microsoft JhengHei";
        background: radial-gradient(
          circle at top,
          color-mix(in srgb, CanvasText 5%, Canvas),
          Canvas
        );
        color: var(--text);
      }
      .container {
        width: 100%;
        max-width: 420px;
        padding: 16px;
      }
      .card {
        border-radius: 16px;
        border: 1px solid var(--border);
        background: var(--surface);
        padding: 24px 20px 20px;
        box-shadow: 0 12px 30px rgba(0, 0, 0, 0.12);
      }
      .logo {
        font-weight: 700;
        font-size: 22px;
        margin-bottom: 4px;
        text-align: center;
      }
      .subtitle {
        text-align: center;
        font-size: 14px;
        margin: 0 0 20px;
        opacity: 0.9;
      }
      .content {
        font-size: 14px;
        line-height: 1.6;
        margin-bottom: 20px;
      }
      .hint {
        font-size: 13px;
        color: var(--muted);
        margin: 0 0 20px;
      }
      .actions-row {
        display: flex;
        justify-content: center;
        margin-top: 8px;
      }
      button {
        font-family: inherit;
        cursor: pointer;
      }
      .btn-primary {
        padding: 10px 18px;
        border-radius: 999px;
        border: 1px solid var(--border);
        background: var(--btn-bg);
        color: var(--text);
        font-size: 14px;
        font-weight: 500;
        min-width: 160px;
        text-align: center;
      }
      .btn-primary:hover:enabled {
        background: var(--btn-bg-hover);
      }
      .btn-primary:disabled {
        opacity: 0.6;
        cursor: default;
      }
      .back-home {
        margin-top: 12px;
        text-align: center;
        font-size: 13px;
      }
      .back-home a {
        color: inherit;
        text-decoration: underline;
      }
      /* Email fallback input (方案 B) */
      .email-fallback {
        margin-top: 16px;
        width: 100%;
        text-align: left;
      }
      .field-label {
        display: block;
        font-size: 13px;
        color: rgba(255, 255, 255, 0.78);
        margin-bottom: 6px;
      }
      .field-input {
        width: 100%;
        padding: 12px 12px;
        border-radius: 12px;
        border: 1px solid rgba(255, 255, 255, 0.18);
        background: rgba(0, 0, 0, 0.35);
        color: #fff;
        outline: none;
        box-sizing: border-box;
        max-width: 100%;
      }
      .field-input:focus {
        border-color: rgba(255, 255, 255, 0.35);
      }
      .field-hint {
        margin-top: 6px;
        font-size: 12px;
        color: #ff6b6b;
      }
    </style>
  </head>
  <body>
    <div class="container">
      <div class="card">
        <div class="logo">PCBuild-zh</div>
        <p class="subtitle">請前往電子郵件收件匣完成驗證</p>

        <div id="message" class="content">
          我們已將驗證信寄送到您註冊時填寫的電子郵件信箱。請在 24 小時內開啟信件，並點擊信中的「完成帳號驗證」按鈕，以啟用您的
          PCBuild 帳號。
        </div>

        <p class="hint" id="hint-text">
          如果在收件匣中找不到信件，請檢查垃圾郵件或促銷信件匣。
        </p>
        <div id="email-fallback" class="email-fallback" style="display:none;">
        <label class="field-label" for="fallback-email">註冊 Email</label>
        <input
          id="fallback-email"
          class="field-input"
          type="email"
          inputmode="email"
          autocomplete="email"
          placeholder="請輸入註冊 Email"
        />
        <p class="field-hint" id="fallback-email-error" style="display:none;"></p>
      </div>

        <div class="actions-row">
          <button id="resend-button" type="button" class="btn-primary">
            重新寄送驗證信
          </button>
        </div>
        <p class="field-hint" id="cooldown-hint" style="display:none;"></p>
      </div>

      <div class="back-home" id="back-link-wrap">
        <a id="back-link" href="/login.html">已完成驗證？前往登入</a>
      </div>
    </div>

    <script>
      // =========================================================
      // verify-email-pending.html
      // - 本頁不在載入時自動寄信（避免頁面導向造成重複寄送）
      // - 冷卻倒數以 sessionStorage 保留，允許 reload 後恢復
      // - 方案 A：register 成功後把 email + expiresAt 存進 sessionStorage，本頁可顯示遮罩 email
      // - 方案 B：若讀不到 email，就顯示輸入框讓使用者補輸入 email 才能重寄
      // =========================================================

      // === sessionStorage keys（請確保與 register.html / index.html 使用相同 key）
      const EMAIL_KEY = "pcbuild_verify_email";
      const EMAIL_EXPIRES_AT_KEY = "pcbuild_verify_email_expires_at"; // 毫秒 timestamp
      const FLOW_KEY = "pcbuild_verify_flow"; // "signup" | "home"
      const COOLDOWN_KEY = "pcbuild_verify_cooldown_until"; // 毫秒 timestamp

      const DEFAULT_MIN_INTERVAL_SECONDS = 60;

      // DOM
      const messageEl = document.getElementById("message");
      const hintTextEl = document.getElementById("hint-text");
      const resendBtn = document.getElementById("resend-button");
      const backLinkEl = document.getElementById("back-link");

      const fallbackWrapEl = document.getElementById("email-fallback");
      const fallbackEmailEl = document.getElementById("fallback-email");
      const fallbackErrEl = document.getElementById("fallback-email-error");
      const cooldownHintEl = document.getElementById("cooldown-hint");
      const RESEND_BTN_BASE_TEXT = "重新寄送驗證信";

      // State
      let currentEmail = "";
      let isLoggedIn = false;
      let isActive = false; // 只有 isLoggedIn=true 時才可信
      let countdownTimer = null;
      let remainingSeconds = 0;

      function safeGetSessionItem(key) {
        try {
          return sessionStorage.getItem(key);
        } catch (e) {
          return null;
        }
      }
      function safeSetSessionItem(key, value) {
        try {
          sessionStorage.setItem(key, value);
        } catch (e) {}
      }
      function safeRemoveSessionItem(key) {
        try {
          sessionStorage.removeItem(key);
        } catch (e) {}
      }

      function setBackLink(flow) {
        if (!backLinkEl) return;
        if (flow === "home") {
          backLinkEl.href = "/";
          backLinkEl.textContent = "已完成驗證？回到首頁";
        } else {
          backLinkEl.href = "/login.html";
          backLinkEl.textContent = "已完成驗證？前往登入";
        }
      }

      function maskEmailFixed(email) {
        const parts = String(email || "").split("@");
        if (parts.length !== 2) return "";
        const local = parts[0] || "";
        const domain = parts[1] || "";
        if (!local || !domain) return "";

        const STAR_COUNT = 6; // 固定數量，不反映真實長度
        const prefix = (local + "**").slice(0, 2); // local 不足 2 也會補齊
        return `${prefix}${"*".repeat(STAR_COUNT)}@${domain}`;
      }

      function readStoredEmail() {
        const rawEmail = safeGetSessionItem(EMAIL_KEY) || "";
        const rawExp = safeGetSessionItem(EMAIL_EXPIRES_AT_KEY) || "";
        if (!rawEmail) return "";

        if (rawExp) {
          const exp = Number(rawExp);
          if (!Number.isFinite(exp) || Date.now() > exp) {
            safeRemoveSessionItem(EMAIL_KEY);
            safeRemoveSessionItem(EMAIL_EXPIRES_AT_KEY);
            return "";
          }
        }
        return rawEmail;
      }

      function renderFallback(show) {
        if (!fallbackWrapEl) return;
        fallbackWrapEl.style.display = show ? "" : "none";
        if (fallbackErrEl) {
          fallbackErrEl.style.display = "none";
          fallbackErrEl.textContent = "";
        }
      }

      function setFallbackError(msg) {
        if (!fallbackErrEl) return;
        if (!msg) {
          fallbackErrEl.style.display = "none";
          fallbackErrEl.textContent = "";
          return;
        }
        fallbackErrEl.textContent = msg; // textContent 安全
        fallbackErrEl.style.display = "";
      }

      function renderUnverified(flow) {
        setBackLink(flow);

        if (flow === "home") {
          messageEl.textContent =
            "您的帳號尚未完成 Email 驗證。請至註冊信箱開啟驗證信並完成驗證。";
          hintTextEl.textContent =
            `完成驗證後，回到首頁重新整理即可開始使用。若未收到或信件已過期，可使用下方按鈕重新寄送（每次間隔 ${DEFAULT_MIN_INTERVAL_SECONDS} 秒）。\n`;
        } else {
          const masked = currentEmail ? maskEmailFixed(currentEmail) : "";
          messageEl.textContent = masked
            ? `我們已將驗證信寄送到 ${masked}。請至註冊信箱開啟驗證信並完成驗證。`
            : "請至註冊信箱開啟驗證信並完成驗證。";
          hintTextEl.textContent =
            `完成驗證後，請前往登入頁重新登入，以更新帳號狀態。若未收到或信件已過期，可使用下方按鈕重新寄送（每次間隔 ${DEFAULT_MIN_INTERVAL_SECONDS} 秒）。\n`;
        }
      }

      function renderAlreadyVerified(flow) {
        // 已完成驗證：依 flow + 是否有合法 session 決定導引
        if (flow === "home" && isLoggedIn) {
          messageEl.textContent =
            "您的帳號已完成 Email 驗證。您目前已登入，可直接回到首頁繼續使用。";
          hintTextEl.textContent =
            "若首頁仍顯示「尚未驗證」，請回到首頁後重新整理一次。";
          setBackLink("home");
        } else {
          messageEl.textContent =
            "您的帳號已完成 Email 驗證。為了更新帳號狀態，請前往登入頁重新登入。";
          hintTextEl.textContent =
            "您可以關閉此頁面，或點擊下方「前往登入」連結。";
          setBackLink("signup");
        }

        resendBtn.disabled = true;
        resendBtn.textContent = "已完成驗證";

        // 已完成就不需要留存 email（降低留存時間）
        safeRemoveSessionItem(EMAIL_KEY);
        safeRemoveSessionItem(EMAIL_EXPIRES_AT_KEY);
        renderFallback(false);

        // 已完成驗證：停止倒數並清除冷卻
        _stopCooldownTimer();
        _clearCooldownStorage();
        if (cooldownHintEl) {
          cooldownHintEl.textContent = "";
          cooldownHintEl.style.display = "none";
        }
      }

      function _readCooldownUntilMs() {
        const raw = safeGetSessionItem(COOLDOWN_KEY);
        if (!raw) return null;
        const ms = Number(raw);
        return Number.isFinite(ms) ? ms : null;
      }

      function _writeCooldownUntilMs(untilMs) {
        safeSetSessionItem(COOLDOWN_KEY, String(untilMs));
      }

      function _clearCooldownStorage() {
        safeRemoveSessionItem(COOLDOWN_KEY);
      }

      function _stopCooldownTimer() {
        if (countdownTimer) {
          clearInterval(countdownTimer);
          countdownTimer = null;
        }
      }

      function _renderCooldownUI(remainingSeconds) {
        // 按鈕只做 disabled，不顯示秒數
        resendBtn.disabled = remainingSeconds > 0;
        resendBtn.textContent = RESEND_BTN_BASE_TEXT;

        if (!cooldownHintEl) return;

        if (remainingSeconds > 0) {
          cooldownHintEl.style.display = "";
          cooldownHintEl.textContent = `驗證信寄送太頻繁，請在 ${remainingSeconds} 秒後再試。`;
        } else {
          cooldownHintEl.textContent = "";
          cooldownHintEl.style.display = "none";
        }
      }

      function _startCooldown(untilMs) {
        _stopCooldownTimer();

        const tick = () => {
          const remaining = Math.max(0, Math.ceil((untilMs - Date.now()) / 1000));

          if (remaining <= 0) {
            _clearCooldownStorage();
            _renderCooldownUI(0);
            _stopCooldownTimer();
            return;
          }

          _renderCooldownUI(remaining);
        };

        tick();
        countdownTimer = setInterval(tick, 250);
      }

      function _applyCooldownSeconds(seconds) {
        const s = Number(seconds);
        const sec = Number.isFinite(s) && s > 0 ? Math.ceil(s) : DEFAULT_MIN_INTERVAL_SECONDS;
        const untilMs = Date.now() + sec * 1000;
        _writeCooldownUntilMs(untilMs);
        _startCooldown(untilMs);
      }

      function restoreCooldownFromStorage() {
        const untilMs = _readCooldownUntilMs();
        if (untilMs && untilMs > Date.now()) {
          _startCooldown(untilMs);
        } else {
          _clearCooldownStorage();
          _renderCooldownUI(0);
        }
      }

      function parseRetryAfterSeconds(resp) {
        const header = resp.headers.get("Retry-After");
        if (!header) return null;
        const n = Number(header);
        if (Number.isFinite(n) && n > 0) return Math.ceil(n);
        return null;
      }

      function isValidEmailFormat(email) {
        const s = String(email || "").trim();
        if (!s) return false;
        const at = s.indexOf("@");
        if (at <= 0) return false;
        if (at === s.length - 1) return false;
        return true;
      }

      async function tryFetchMe() {
        try {
          const resp = await fetch("/api/auth/me", {
            method: "GET",
            credentials: "same-origin",
          });
          if (!resp.ok) return null;
          return await resp.json();
        } catch (e) {
          return null;
        }
      }

      function getFlow() {
        const raw = safeGetSessionItem(FLOW_KEY);
        if (raw === "signup" || raw === "home") return raw;
        return isLoggedIn ? "home" : "signup";
      }

      async function init() {
        restoreCooldownFromStorage();

        const me = await tryFetchMe();
        if (me) {
          isLoggedIn = true;
          isActive = !!me.is_active;
          currentEmail = String(me.email || "");
        } else {
          isLoggedIn = false;
          isActive = false;
          currentEmail = readStoredEmail();
        }

        const flow = getFlow();

        if (isLoggedIn && isActive) {
          renderAlreadyVerified(flow);
          return;
        }

        renderUnverified(flow);

        // 未登入且讀不到 email → 顯示方案 B
        if (!currentEmail && !isLoggedIn) {
          renderFallback(true);
          return;
        }
        renderFallback(false);
      }

      resendBtn.addEventListener("click", async () => {
        const untilMs = _readCooldownUntilMs();
        if (untilMs && untilMs > Date.now()) {
          _startCooldown(untilMs);
          return;
        }

        // 若已登入，先確認是否已完成驗證（避免剛驗證完仍停留在 pending）
        if (isLoggedIn) {
          const me = await tryFetchMe();
          if (me) {
            isActive = !!me.is_active;
            currentEmail = String(me.email || "");
            if (isActive) {
              renderAlreadyVerified(getFlow());
              return;
            }
          }
        }

        let emailToUse = currentEmail;

        // 方案 B：需要輸入 email
        if (!emailToUse && fallbackEmailEl) {
          const input = String(fallbackEmailEl.value || "").trim();
          if (!isValidEmailFormat(input)) {
            setFallbackError("請輸入正確的 Email 格式。");
            return;
          }
          setFallbackError("");
          emailToUse = input;

          // 存短期 expiresAt，讓 reload 可恢復遮罩顯示（降低留存）
          safeSetSessionItem(EMAIL_KEY, emailToUse);
          safeSetSessionItem(
            EMAIL_EXPIRES_AT_KEY,
            String(Date.now() + 30 * 60 * 1000) // 30 分鐘
          );
        }

        if (!emailToUse) return;

        resendBtn.disabled = true;

        try {
          const resp = await fetch("/api/auth/resend-verification", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ email: emailToUse }),
            credentials: "same-origin",
          });
          if (resp.ok || resp.status === 429) {
            const retry = parseRetryAfterSeconds(resp) || DEFAULT_MIN_INTERVAL_SECONDS;
            _applyCooldownSeconds(retry);
            return;
          }

          // 其它狀態：保守起見仍做冷卻，避免被濫用
          _applyCooldownSeconds(DEFAULT_MIN_INTERVAL_SECONDS);
          } catch (e) {
            _applyCooldownSeconds(DEFAULT_MIN_INTERVAL_SECONDS);
          }
      });

      init();
    </script>
  </body>
</html>
