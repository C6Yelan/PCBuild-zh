<!doctype html>
<html lang="zh-Hant">
  <head>
    <meta charset="utf-8" />
    <title>請驗證電子郵件 · PCBuild-zh</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <style>
      :root {
        color-scheme: light dark;
      }
      :root {
        --surface: Canvas;
        --text: CanvasText;
        --border: color-mix(in srgb, CanvasText 12%, Canvas);
        --btn-bg: color-mix(in srgb, CanvasText 5%, Canvas);
        --btn-bg-hover: color-mix(in srgb, CanvasText 10%, Canvas);
        --muted: color-mix(in srgb, CanvasText 45%, Canvas);
      }
      body {
        margin: 0;
        min-height: 100vh;
        display: flex;
        align-items: center;
        justify-content: center;
        font-family: ui-sans-serif, system-ui, -apple-system, "Segoe UI",
          "Noto Sans TC", "PingFang TC", "Microsoft JhengHei";
        background: radial-gradient(
          circle at top,
          color-mix(in srgb, CanvasText 5%, Canvas),
          Canvas
        );
        color: var(--text);
      }
      .container {
        width: 100%;
        max-width: 420px;
        padding: 16px;
      }
      .card {
        border-radius: 16px;
        border: 1px solid var(--border);
        background: var(--surface);
        padding: 24px 20px 20px;
        box-shadow: 0 12px 30px rgba(0, 0, 0, 0.12);
      }
      .logo {
        font-weight: 700;
        font-size: 22px;
        margin-bottom: 4px;
        text-align: center;
      }
      .subtitle {
        text-align: center;
        font-size: 14px;
        margin: 0 0 20px;
        opacity: 0.9;
      }
      .content {
        font-size: 14px;
        line-height: 1.6;
        margin-bottom: 20px;
      }
      .hint {
        font-size: 13px;
        color: var(--muted);
        margin: 0 0 20px;
      }
      .actions-row {
        display: flex;
        justify-content: center;
        margin-top: 8px;
      }
      button {
        font-family: inherit;
        cursor: pointer;
      }
      .btn-primary {
        padding: 10px 18px;
        border-radius: 999px;
        border: 1px solid var(--border);
        background: var(--btn-bg);
        color: var(--text);
        font-size: 14px;
        font-weight: 500;
        min-width: 160px;
        text-align: center;
      }
      .btn-primary:hover:enabled {
        background: var(--btn-bg-hover);
      }
      .btn-primary:disabled {
        opacity: 0.6;
        cursor: default;
      }
      .back-home {
        margin-top: 12px;
        text-align: center;
        font-size: 13px;
      }
      .back-home a {
        color: inherit;
        text-decoration: underline;
      }
    </style>
  </head>
  <body>
    <div class="container">
      <div class="card">
        <div class="logo">PCBuild-zh</div>
        <p class="subtitle">請前往電子郵件收件匣完成驗證</p>

        <div id="message" class="content">
          我們已將驗證信寄送到您註冊時填寫的電子郵件信箱。請在 24 小時內開啟信件，並點擊信中的「完成帳號驗證」按鈕，以啟用您的
          PCBuild 帳號。
        </div>

        <p class="hint" id="hint-text">
          如果在收件匣中找不到信件，請檢查垃圾郵件或促銷信件匣。
        </p>

        <div class="actions-row">
          <button id="resend-button" type="button" class="btn-primary">
            重新寄送驗證信
          </button>
        </div>
      </div>

      <div class="back-home">
        已完成驗證？<a href="/">回到首頁</a>
      </div>
    </div>

    <script>
      const RESEND_COOLDOWN_SECONDS = 60;
      const COOLDOWN_KEY = "pcbuild_verify_cooldown_until";

      const messageEl = document.getElementById("message");
      const resendButton = document.getElementById("resend-button");
      const hintText = document.getElementById("hint-text");

      let email = "";
      let remaining = 0;
      let timerId = null;
      let userIsActive = false;

      function updateButton() {
        if (!email) {
          // 沒有取得 email（例如尚未登入），按鈕保持停用
          resendButton.disabled = true;
          resendButton.textContent = "重新寄送驗證信";
          return;
        }

        if (userIsActive) {
          // 已完成驗證時按鈕維持停用
          resendButton.disabled = true;
          resendButton.textContent = "已完成驗證";
          return;
        }

        if (remaining > 0) {
          resendButton.disabled = true;
          resendButton.textContent = `重新寄送驗證信（${remaining}）`;
        } else {
          resendButton.disabled = false;
          resendButton.textContent = "重新寄送驗證信";
        }
      }

      function startCooldown(seconds) {
        const sec = Math.max(0, Math.floor(Number(seconds) || 0));
        remaining = sec;
        updateButton();

        if (timerId !== null) {
          clearInterval(timerId);
          timerId = null;
        }

        if (remaining <= 0) {
          try { sessionStorage.removeItem(COOLDOWN_KEY); } catch (e) {}
          return;
        }

        timerId = setInterval(() => {
          remaining -= 1;
          if (remaining <= 0) {
            remaining = 0;
            clearInterval(timerId);
            timerId = null;
            try { sessionStorage.removeItem(COOLDOWN_KEY); } catch (e) {}
          }
          updateButton();
        }, 1000);
      }

      function persistCooldownSeconds(seconds) {
        const sec = Math.max(0, Math.floor(Number(seconds) || 0));
        const until = Date.now() + sec * 1000;
        try { sessionStorage.setItem(COOLDOWN_KEY, String(until)); } catch (e) {}
      }

      function loadPersistedCooldown() {
        try {
          const raw = sessionStorage.getItem(COOLDOWN_KEY);
          const until = raw ? parseInt(raw, 10) : 0;
          if (Number.isFinite(until) && until > Date.now()) {
            const sec = Math.ceil((until - Date.now()) / 1000);
            startCooldown(sec);
          }
        } catch (e) {
          // ignore
        }
      }

      function parseRetryAfterSeconds(resp) {
        const v = resp.headers.get("Retry-After");
        const n = v ? parseInt(v, 10) : NaN;
        return Number.isFinite(n) && n > 0 ? n : null;
      }

      // 已完成驗證時的統一顯示
      function showAlreadyVerified() {
        userIsActive = true;
        messageEl.textContent =
          "您的帳號已完成 Email 驗證，可以直接回首頁開始使用 PCBuild。";
        hintText.textContent =
          "您可以關閉此頁面，或點擊下方「回到首頁」連結。";
        remaining = 0;
        if (timerId !== null) {
          clearInterval(timerId);
          timerId = null;
        }
        updateButton();
      }

      // 從後端（已有 HttpOnly Cookie）取得目前登入的使用者資訊
      async function loadCurrentUser() {
        try {
          const resp = await fetch("/api/auth/me", {
            method: "GET",
            credentials: "same-origin",
          });

          if (!resp.ok) {
            // 例如 401：沒有有效 session，提示使用者需要重新註冊 / 登入
            messageEl.textContent =
              "目前尚未登入，無法重新寄送驗證信。請重新完成註冊流程，或登入後再試。";
            hintText.textContent =
              "如果您已完成驗證，請回到首頁重新整理頁面。";
            email = "";
            userIsActive = false;
            updateButton();
            return;
          }

          const data = await resp.json();
          email = data.email || "";
          userIsActive = !!data.is_active;

          if (userIsActive) {
            // 這個 session 的使用者已經啟用，直接提示即可
            showAlreadyVerified();
            return;
          }

          messageEl.textContent =
            "您的帳號尚未完成 Email 驗證。請至註冊信箱開啟驗證信並完成驗證。若未收到或信件已過期，可使用下方按鈕重新寄送（每次間隔 60 秒）。";
          hintText.textContent =
            "重新寄送不會在此頁顯示成功或失敗，但按鈕會依冷卻時間暫停。";

          // 若使用者是從首頁點「尚未驗證」進來，這裡會讀到 sessionStorage 並開始倒數
          loadPersistedCooldown();

        } catch (err) {
          console.error("loadCurrentUser failed:", err);
          messageEl.textContent =
            "目前無法取得驗證資訊，請稍後再試。";
          email = "";
          userIsActive = false;
        } finally {
          updateButton();
        }
      }

      resendButton.addEventListener("click", async () => {
      if (!email) return;
      if (remaining > 0) return;

      // 先確認最新狀態：使用者可能已在別的分頁完成驗證
      try {
        const statusResp = await fetch("/api/auth/me", {
          method: "GET",
          credentials: "same-origin",
        });
        if (statusResp.ok) {
          const statusData = await statusResp.json();
          if (statusData.is_active) {
            showAlreadyVerified();
            return;
          }
        }
      } catch (err) {
        console.error("check active status failed:", err);
        // 檢查失敗就繼續嘗試重寄（不影響）
      }

      try {
        const resp = await fetch("/api/auth/resend-verification", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          credentials: "same-origin",
          body: JSON.stringify({ email }),
        });

        if (resp.ok) {
          persistCooldownSeconds(RESEND_COOLDOWN_SECONDS);
          startCooldown(RESEND_COOLDOWN_SECONDS);
          return;
        }

        if (resp.status === 429) {
          // 後端可能回 Retry-After（建議你已在 auth.py 加上）
          const wait = parseRetryAfterSeconds(resp) ?? RESEND_COOLDOWN_SECONDS;
          persistCooldownSeconds(wait);
          startCooldown(wait);
          return;
        }

        // 其他錯誤：不啟動倒數（避免「假倒數」）
        console.error("resend verification failed:", resp.status);
      } catch (err) {
        console.error("resend verification failed:", err);
      }
    });

      // 初始化：從後端讀取使用者資訊
      loadCurrentUser();
    </script>
  </body>
</html>
